name: Deploy TchouTchou MCP to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Annule les d√©ploiements pr√©c√©dents
concurrency:
  group: deploy-tchoutchou-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy via Portainer
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Red√©ploiement via Portainer API
    - name: Redeploy via Portainer Git
      run: |
        echo "üîê Authentification √† Portainer..."
        
        # Authentification Portainer
        AUTH_TOKEN=$(curl -s -X POST \
          "${{ secrets.PORTAINER_URL }}/api/auth" \
          -H "Content-Type: application/json" \
          -d '{"Username":"${{ secrets.PORTAINER_USERNAME }}","Password":"${{ secrets.PORTAINER_PASSWORD }}"}' \
          | jq -r '.jwt')
        
        if [ -z "$AUTH_TOKEN" ] || [ "$AUTH_TOKEN" = "null" ]; then
          echo "‚ùå Erreur d'authentification Portainer"
          exit 1
        fi
        
        echo "‚úÖ Authentification Portainer r√©ussie"
        
        # Git redeploy
        echo "üîÑ Red√©ploiement de la stack depuis Git..."
        
        RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
          "${{ secrets.PORTAINER_URL }}/api/stacks/${{ secrets.PORTAINER_STACK_ID }}/git/redeploy?endpointId=${{ secrets.PORTAINER_ENDPOINT_ID }}" \
          -H "Authorization: Bearer $AUTH_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{
            "prune": false,
            "pullImage": true,
            "repositoryAuthentication": true,
            "repositoryUsername": "${{ github.actor }}",
            "repositoryPassword": "${{ secrets.GITHUB_TOKEN }}",
            "repositoryReferenceName": "refs/heads/main"
          }')
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')
        
        if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
          echo "‚úÖ Stack red√©ploy√©e depuis Git (HTTP $HTTP_CODE)"
        else
          echo "‚ùå Erreur lors du red√©ploiement (HTTP $HTTP_CODE)"
          echo "$BODY"
          exit 1
        fi
        
        # Attendre le red√©marrage complet
        echo "‚è≥ Attente de 30 secondes pour le d√©marrage du conteneur..."
        sleep 30
    
    # Test du d√©ploiement
    - name: Test deployment
      run: |
        echo "üîç Test de l'API via Traefik..."
        
        # Test avec retry en cas d'√©chec temporaire
        for i in {1..5}; do
          echo "üîÑ Tentative $i/5..."
          
          if curl -f -k https://tchoutchou-mcp.rankorr.red/health; then
            echo ""
            echo "‚úÖ API accessible via Traefik !"
            
            # Test endpoint MCP
            echo "üîç Test de l'endpoint MCP..."
            curl -f -k https://tchoutchou-mcp.rankorr.red/mcp || true
            
            exit 0
          else
            echo "‚ö†Ô∏è √âchec tentative $i, attente 10s..."
            sleep 10
          fi
        done
        
        echo "‚ùå L'API n'est pas accessible apr√®s 5 tentatives"
        exit 1
    
    # Notification
    - name: Deployment notification
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "üéâ D√©ploiement r√©ussi: https://tchoutchou-mcp.rankorr.red"
          echo "üìç Endpoint MCP: https://tchoutchou-mcp.rankorr.red/mcp"
          echo "üíö Health: https://tchoutchou-mcp.rankorr.red/health"
        else
          echo "‚ùå √âchec du d√©ploiement"
        fi
