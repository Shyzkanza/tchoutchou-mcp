---
description: Structure des r√©ponses d'outils MCP pour ChatGPT Apps SDK
globs: 
  - src/tools/**/*.ts
  - src/servers/**/*.ts
alwaysApply: false
---

# OpenAI Apps SDK - Structure des R√©ponses

## Anatomie d'une R√©ponse Tool

```typescript
{
  // 1. CONTENT - Narration pour le mod√®le ET l'utilisateur
  content: [{
    type: 'text',
    text: 'Markdown narration visible dans le chat'
  }],

  // 2. STRUCTURED CONTENT - JSON l√©ger visible par widget ET mod√®le
  // ‚ö†Ô∏è CRITIQUE: Impacte les performances si trop gros
  structuredContent: {
    type: 'trainDepartures',
    summary: 'Prochains trains depuis Paris Gare de Lyon',
    items: [/* donn√©es concises */]
  },

  // 3. _META - Donn√©es riches JAMAIS vues par le mod√®le
  _meta: {
    'openai/outputTemplate': 'template://departures-widget',
    'openai/closeWidget': false,
    fullDetails: {/* donn√©es compl√®tes */},
    rawApiResponse: {/* donn√©es brutes API */}
  }
}
```

## Les 3 Parties Expliqu√©es

### 1. `content` - Narration

**Usage**: Texte markdown affich√© dans le chat, visible par utilisateur ET mod√®le.

```typescript
content: [{
  type: 'text',
  text: `## Prochains d√©parts Paris Gare de Lyon
  
üöÑ TGV 6201 ‚Üí Lyon Part-Dieu - 14:30
üöÑ TGV 6203 ‚Üí Marseille - 14:45

*Donn√©es en temps r√©el*`
}]
```

**R√®gles**:
- ‚úÖ Markdown pour formattage
- ‚úÖ R√©sum√© concis des r√©sultats
- ‚úÖ Utilis√© comme fallback si widget fail
- ‚ùå Pas de donn√©es sensibles

### 2. `structuredContent` - Donn√©es pour Widget + Mod√®le

**Usage**: JSON structur√© que le widget utilise pour render ET que le mod√®le peut raisonner dessus.

```typescript
structuredContent: {
  type: 'departures',
  station: { name: 'Paris Gare de Lyon', code: 'PAGL' },
  departures: [
    { train: 'TGV 6201', destination: 'Lyon', time: '14:30', platform: '5' },
    { train: 'TGV 6203', destination: 'Marseille', time: '14:45', platform: '12' }
  ]
}
```

**R√®gles CRITIQUES**:
- ‚úÖ **Garder l√©ger** : < 4k tokens id√©alement
- ‚úÖ Donn√©es essentielles uniquement
- ‚úÖ Structure simple et plate
- ‚ùå **Pas de donn√©es volumineuses** (images base64, logs, etc.)
- ‚ùå **Pas de donn√©es sensibles** (tokens, credentials)

> ‚ö†Ô∏è "Oversized payloads degrade model performance" - OpenAI

### 3. `_meta` - Donn√©es Riches (Widget Only)

**Usage**: Donn√©es compl√®tes que SEUL le widget voit. Le mod√®le n'y a JAMAIS acc√®s.

```typescript
_meta: {
  // M√©tadonn√©es syst√®me
  'openai/outputTemplate': 'template://departures-widget',
  'openai/closeWidget': false,
  'openai/widgetSessionId': 'session-abc123',

  // Donn√©es riches pour le widget
  fullSchedule: {
    allDepartures: [/* tous les d√©parts d√©taill√©s */],
    delays: [/* informations de retard */]
  },
  
  // Donn√©es de debug/tra√ßabilit√©
  apiRequestId: 'req_xyz789',
  processingTime: 245
}
```

**R√®gles**:
- ‚úÖ Donn√©es volumineuses ici
- ‚úÖ Donn√©es d√©taill√©es pour rich UI
- ‚úÖ M√©tadonn√©es de debug
- ‚ùå Le mod√®le ne voit JAMAIS `_meta`

## Pattern de R√©ponse Complet

```typescript
async function handleDeparturesTool(params: DeparturesInput): Promise<ToolResponse> {
  // 1. R√©cup√©rer les donn√©es
  const apiData = await fetchSNCFAPI(params.station);
  
  // 2. Construire la r√©ponse
  return {
    // Narration markdown (fallback + contexte)
    content: [{
      type: 'text',
      text: buildDeparturesNarration(apiData)
    }],
    
    // Donn√©es structur√©es L√âG√àRES pour widget + mod√®le
    structuredContent: {
      type: 'departures',
      station: apiData.station.name,
      departures: apiData.departures.slice(0, 5).map(dep => ({
        train: dep.trainNumber,
        destination: dep.destination,
        time: dep.scheduledTime,
        platform: dep.platform
      }))
    },
    
    // Donn√©es riches pour widget uniquement
    _meta: {
      'openai/outputTemplate': 'template://departures-widget',
      'openai/widgetAccessible': true,
      
      // Donn√©es compl√®tes que le mod√®le ne voit pas
      fullApiResponse: apiData,
      allDepartures: apiData.departures,
      disruptions: apiData.disruptions || []
    }
  };
}
```

## Anti-Patterns √† √âviter

### ‚ùå structuredContent trop gros

```typescript
// ‚ùå MAUVAIS - Donn√©es volumineuses dans structuredContent
structuredContent: {
  allStations: [/* 100 gares avec d√©tails */],
  historicalData: [/* 30 jours d'historique */],
  rawApiResponse: {/* r√©ponse API compl√®te */}
}
```

### ‚ùå Donn√©es sensibles dans content/structuredContent

```typescript
// ‚ùå MAUVAIS - Token visible par le mod√®le
structuredContent: {
  apiToken: 'secret_key_123',
  userId: 'user_internal_id'
}
```

### ‚úÖ Pattern correct

```typescript
// ‚úÖ BON - S√©paration claire
structuredContent: {
  summary: 'Prochains trains Paris ‚Üí Lyon',
  items: [/* 3-5 items essentiels */]
},
_meta: {
  fullData: {/* donn√©es compl√®tes */},
  credentials: {/* si absolument n√©cessaire */}
}
```

## Checklist R√©ponse

Avant de retourner une r√©ponse :

- [ ] `content` contient un r√©sum√© markdown lisible
- [ ] `structuredContent` est **l√©ger** (< 4k tokens)
- [ ] `structuredContent` ne contient que l'essentiel
- [ ] Donn√©es volumineuses dans `_meta`
- [ ] Pas de donn√©es sensibles dans `content`/`structuredContent`
- [ ] `_meta['openai/outputTemplate']` si widget
- [ ] Types de r√©ponse bien d√©finis
