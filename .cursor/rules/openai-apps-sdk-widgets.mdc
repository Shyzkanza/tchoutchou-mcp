---
description: D√©veloppement des widgets UI pour ChatGPT Apps SDK
globs: 
  - src/resources/**/*.html
  - src/resources/**/*.ts
  - src/widgets/**/*
  - web/**/*
alwaysApply: false
---

# OpenAI Apps SDK - D√©veloppement Widgets

## Enregistrement d'une Resource Widget

```typescript
server.registerResource({
  uri: 'template://departures-widget',
  name: 'Departures Widget',
  mimeType: 'text/html+skybridge',  // ‚ö†Ô∏è OBLIGATOIRE - Active le runtime
  text: async () => fs.readFileSync('./widgets/departures.html', 'utf-8'),
  _meta: {
    'openai/widgetCSP': {
      'connect-src': ['https://api.sncf.com'],
      'img-src': ['https://cdn.sncf.com']
    },
    'openai/widgetDescription': 'Affiche les d√©parts de trains'
  }
});
```

**Points critiques**:
- ‚úÖ `mimeType: 'text/html+skybridge'` est OBLIGATOIRE
- ‚úÖ D√©clarer les domaines CSP dans `_meta['openai/widgetCSP']`
- ‚úÖ Changer l'URI lors de breaking changes (√©vite le cache)

## Structure HTML Widget

```html
<!DOCTYPE html>
<html>
<head>
  <style>
    /* ‚ö†Ô∏è TOUT le CSS doit √™tre inline */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; }
    .container { padding: 16px; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ‚ö†Ô∏è TOUT le JS doit √™tre inline - pas de scripts externes
    
    // R√©cup√©rer les donn√©es OpenAI
    const { toolOutput, toolInput, widgetState, displayMode, locale } = window.openai;
    
    // Initialiser depuis l'√©tat sauvegard√©
    let state = widgetState || { selectedIndex: 0 };
    
    // Render avec les donn√©es du serveur
    function render() {
      const app = document.getElementById('app');
      
      if (toolOutput?.structuredContent) {
        const data = toolOutput.structuredContent;
        app.innerHTML = `
          <div class="container">
            <h2>${data.station}</h2>
            <ul>
              ${data.departures.map(d => `
                <li>${d.train} ‚Üí ${d.destination} - ${d.time}</li>
              `).join('')}
            </ul>
          </div>
        `;
      }
      
      // Utiliser les donn√©es riches de _meta
      if (toolOutput?._meta?.fullData) {
        // Render d√©taill√© avec donn√©es compl√®tes
      }
    }
    
    // Persister l'√©tat
    function saveState(newState) {
      state = { ...state, ...newState };
      window.openai.setWidgetState(state);
    }
    
    // Appeler un outil serveur
    async function refreshData() {
      const result = await window.openai.callTool('sncf.get_departures', {
        stationId: toolInput.stationId
      });
      // result contient structuredContent et _meta
      render();
    }
    
    // Init
    render();
  </script>
</body>
</html>
```

## API window.openai

| Propri√©t√©/M√©thode | Description |
|-------------------|-------------|
| `toolOutput` | Donn√©es du serveur (`structuredContent` + `_meta`) |
| `toolInput` | Param√®tres d'entr√©e du tool |
| `widgetState` | √âtat persist√© du widget (scoped par instance) |
| `displayMode` | Mode: `inline`/`carousel`/`fullscreen`/`pip` |
| `maxHeight` | Hauteur max disponible |
| `locale` | Locale utilisateur (RFC 4647) |
| `callTool(name, payload)` | Invoque un tool serveur |
| `setWidgetState(state)` | Persiste l'√©tat (< 4k tokens) |
| `sendFollowUpMessage(text)` | Envoie un message dans ChatGPT |
| `requestClose()` | Ferme le widget |
| `requestDisplayMode(mode)` | Change le layout |
| `requestModal(options)` | Ouvre un overlay |

## Gestion du State

### Widget State (√âph√©m√®re)

```javascript
// Lire l'√©tat au chargement
let state = window.openai.widgetState || { 
  selectedId: null,
  expanded: false 
};

// Sauvegarder apr√®s chaque changement
function updateState(updates) {
  state = { ...state, ...updates };
  window.openai.setWidgetState(state);  // Synchrone, persistence async
}

// Exemple: s√©lection d'un item
function selectItem(id) {
  updateState({ selectedId: id });
  render();
}
```

**R√®gles**:
- ‚úÖ State scoped √† l'instance du widget (message_id/widgetId)
- ‚úÖ Appeler `setWidgetState` imm√©diatement apr√®s chaque change
- ‚úÖ Garder le payload < 4k tokens (envoy√© au mod√®le)
- ‚ùå Ne persiste PAS entre widgets/conversations

### Business State (Authoritative)

```javascript
// Le serveur est la source de v√©rit√©
async function updateTask(taskId, updates) {
  // 1. Optimistic update UI
  renderLoading();
  
  // 2. Appel serveur
  const result = await window.openai.callTool('tasks.update', {
    id: taskId,
    ...updates
  });
  
  // 3. Re-render avec donn√©es serveur
  if (result.structuredContent) {
    renderTasks(result.structuredContent.tasks);
  }
}
```

## Restrictions Sandbox

### ‚ùå APIs Bloqu√©es
- `alert()`, `confirm()`, `prompt()`
- `navigator.clipboard`
- Scripts externes (`<script src="...">`)
- CSS externes (`<link rel="stylesheet" href="...">`)

### ‚úÖ Autoris√©
- Tous les assets inline (CSS, JS, images base64)
- `fetch()` vers domaines d√©clar√©s en CSP
- APIs DOM standard
- Routing APIs (React Router, etc.)

## Modes d'Affichage

```javascript
const mode = window.openai.displayMode;

switch (mode) {
  case 'inline':
    // Card l√©g√®re dans la conversation
    // Max 2 actions, pas de nested scrolling
    break;
  case 'carousel':
    // 3-8 items, swipe horizontal
    break;
  case 'fullscreen':
    // Exp√©rience riche, composer ChatGPT overlay
    break;
  case 'pip':
    // Fen√™tre flottante persistante
    break;
}

// Demander un changement de mode
window.openai.requestDisplayMode('fullscreen');
```

## Pattern React (Bundl√©)

```typescript
// hooks/useWidgetState.ts
import { useState, useEffect } from 'react';

export function useWidgetState<T>(initialState: T) {
  const [state, setState] = useState<T>(
    window.openai?.widgetState ?? initialState
  );

  useEffect(() => {
    const handler = (event: CustomEvent) => {
      if (event.detail?.key === 'widgetState') {
        setState(event.detail.value);
      }
    };
    window.addEventListener('openai:set_globals', handler as EventListener);
    return () => window.removeEventListener('openai:set_globals', handler as EventListener);
  }, []);

  const updateState = (newState: Partial<T>) => {
    const merged = { ...state, ...newState };
    setState(merged as T);
    window.openai?.setWidgetState(merged);
  };

  return [state, updateState] as const;
}
```

## Checklist Widget

Avant de commit un widget :

- [ ] MIME type `text/html+skybridge`
- [ ] Tout CSS/JS inline (pas de fichiers externes)
- [ ] Domaines CSP d√©clar√©s si fetch externe
- [ ] Gestion de `widgetState` pour persistence
- [ ] Fallback si `toolOutput` est null
- [ ] Responsive (utilise `maxHeight`, `displayMode`)
- [ ] Accessibilit√© basique (contraste, alt text)
- [ ] Pas d'usage de APIs bloqu√©es (alert, clipboard)

## Bonnes Pratiques et Debugging

> **üìö Documentation compl√®te** : Voir la section "Bonnes Pratiques : D√©veloppement de Widgets" dans [`OPENAI_APPS_SDK_REFERENCE.md`](../../OPENAI_APPS_SDK_REFERENCE.md) pour les le√ßons apprises lors du d√©veloppement de widgets MCP.

**Points critiques √† retenir** :

1. **Extraction des donn√©es** : Utiliser une fonction `extractData()` multi-sources qui v√©rifie :
   - `window.openai?.toolOutput`
   - `window.oai?.toolOutput`
   - `structuredContent` direct et nested
   - `text` parsed as JSON

2. **Pattern init/render** : Toujours stocker les donn√©es dans une variable avant de rendre :
   ```javascript
   let widgetData = null;
   function init(data) {
     widgetData = data; // Stocker
     render(); // Puis rendre
   }
   ```

3. **Condition de polling** : V√©rifier uniquement la donn√©e principale, pas les propri√©t√©s secondaires

4. **Tentatives suffisantes** : Utiliser 150 tentatives (15 secondes) pour donn√©es complexes

5. **Pr√©server `_meta`** : Dans `http.ts`, ne jamais √©craser un `_meta` existant d'un tool

Voir la section "Bonnes Pratiques : D√©veloppement de Widgets" dans [`OPENAI_APPS_SDK_REFERENCE.md`](../../OPENAI_APPS_SDK_REFERENCE.md) pour les d√©tails complets, exemples de code, et guide de debugging.
